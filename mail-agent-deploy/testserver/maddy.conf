# Maddy Mail Server Configuration - Simplified
# For LAN use with Thunderbird/iPhone

$(hostname) = mail.local
$(primary_domain) = mail.local
$(local_domains) = $(primary_domain)

state_dir /var/lib/maddy
runtime_dir /run/maddy

tls file /etc/maddy/certs/fullchain.pem /etc/maddy/certs/privkey.pem

# Message storage
storage.imapsql local_mailboxes {
    driver sqlite3
    dsn imapsql.db
}

# Auth table
auth.pass_table local_authdb {
    table sql_table {
        driver sqlite3
        dsn credentials.db
        table_name passwords
    }
}

# IMAP with TLS
imap tls://0.0.0.0:993 tcp://0.0.0.0:143 {
    auth &local_authdb
    storage &local_mailboxes
    insecure_auth
}

# Local delivery target
target.queue local_queue {
    hostname $(hostname)
    target &local_mailboxes
}

# SMTP - receiving mail (port 25)
smtp tcp://0.0.0.0:25 {
    hostname $(hostname)
    
    default_source {
        destination $(local_domains) {
            deliver_to &local_queue
        }
        default_destination {
            reject 550 5.1.1 "User not found"
        }
    }
}

# SMTP submission (port 587)
submission tcp://0.0.0.0:587 {
    hostname $(hostname)
    
    auth &local_authdb
    
    default_source {
        destination $(local_domains) {
            deliver_to &local_queue
        }
        default_destination {
            reject 550 5.1.1 "User not local"
        }
    }
}
